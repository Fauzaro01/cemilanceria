<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Pengguna | Cemilan Ceria</title>
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

  <!-- ðŸ”— Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: '#FF7F00',
              light: '#FFA756',
              dark: '#CC6600',
            }
          }
        }
      }
    }
  </script>

  <!-- ðŸŽ¨ Font & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body {
      font-family: 'Source Sans Pro', system-ui, sans-serif;
    }
    /* Smooth scroll & layout */
    html { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-gray-50">

  <div class="flex min-h-screen">
    <!-- Sidebar (include partial) -->
    <%- include('../partials/user-sidebar.ejs', {activeMenu: 'dashboard'}) %>

    <!-- Main Content -->
    <div class="flex flex-col flex-1">
      <!-- Top Header -->
      <header class="bg-white shadow-sm">
        <div class="px-6 py-4">
          <h1 class="text-2xl font-bold text-gray-800">Dashboard Pengguna</h1>
        </div>
      </header>

      <!-- Content -->
      <main class="flex-1 p-6 overflow-auto">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <!-- Card 1 -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center">
              <div class="p-3 rounded-lg bg-blue-100 text-blue-600">
                <i class="fas fa-shopping-cart text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-gray-500 text-sm">Total Pesanan</p>
                <p class="text-2xl font-bold text-gray-800" id="totalPesanan">0</p>
              </div>
            </div>
          </div>

          <!-- Card 2 -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center">
              <div class="p-3 rounded-lg bg-green-100 text-green-600">
                <i class="fas fa-dollar-sign text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-gray-500 text-sm">Total Pengeluaran</p>
                <p class="text-2xl font-bold text-gray-800" id="totalPengeluaran">Rp 0</p>
              </div>
            </div>
          </div>

          <!-- Card 3 -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <div class="flex items-center">
              <div class="p-3 rounded-lg bg-purple-100 text-purple-600">
                <i class="fas fa-clock text-xl"></i>
              </div>
              <div class="ml-4">
                <p class="text-gray-500 text-sm">Pesanan Pending</p>
                <p class="text-2xl font-bold text-gray-800" id="pesananPending">0</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Orders Section -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Pesanan Terbaru</h2>
          <div id="recentOrders" class="space-y-4">
            <!-- Orders will be populated here -->
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="bg-white border-t border-gray-200 py-4 px-6 text-sm text-gray-600">
        <strong>&copy; 2025 <a href="#" class="text-primary font-medium hover:underline">Cemilan Ceria</a>.</strong>
        All rights reserved.
      </footer>
    </div>
  </div>

  <script>
    // Fetch user statistics from API
    async function fetchStats() {
      try {
        const response = await fetch('/api/user/stats');
        const result = await response.json();
        
        if (result.success) {
          const { totalOrders, totalSpending, pendingOrders } = result.data;
          document.getElementById('totalPesanan').textContent = totalOrders;
          document.getElementById('totalPengeluaran').textContent = 'Rp ' + totalSpending.toLocaleString('id-ID');
          document.getElementById('pesananPending').textContent = pendingOrders;
        }
      } catch (error) {
        console.error('Error fetching stats:', error);
      }
    }

    // Fetch recent orders from API
    async function fetchRecentOrders() {
      try {
        const response = await fetch('/api/user/orders/recent');
        const result = await response.json();
        
        if (result.success) {
          const orders = result.data;
          const recentOrdersContainer = document.getElementById('recentOrders');
          recentOrdersContainer.innerHTML = '';

          if (orders.length === 0) {
            recentOrdersContainer.innerHTML = '<p class="text-gray-500 text-center">Belum ada pesanan</p>';
            return;
          }

          orders.forEach(order => {
            const orderElement = document.createElement('div');
            orderElement.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition cursor-pointer';
            orderElement.onclick = () => window.location.href = `/pesanan/${order.orderNumber}`;
            
            const itemsList = order.orderItems.map(item => item.product.name).join(', ');
            const date = new Date(order.createdAt).toLocaleDateString('id-ID', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            });
            
            const statusMap = {
              'PENDING': { class: 'bg-yellow-100 text-yellow-800', text: 'Pending' },
              'CONFIRMED': { class: 'bg-blue-100 text-blue-800', text: 'Dikonfirmasi' },
              'PROCESSING': { class: 'bg-purple-100 text-purple-800', text: 'Diproses' },
              'SHIPPED': { class: 'bg-indigo-100 text-indigo-800', text: 'Dikirim' },
              'DELIVERED': { class: 'bg-green-100 text-green-800', text: 'Selesai' },
              'CANCELLED': { class: 'bg-red-100 text-red-800', text: 'Dibatalkan' }
            };
            
            const status = statusMap[order.status] || statusMap['PENDING'];
            
            orderElement.innerHTML = `
              <div>
                <p class="font-medium text-gray-800">${order.orderNumber}</p>
                <p class="text-sm text-gray-500">${itemsList}</p>
                <p class="text-xs text-gray-400">${date}</p>
              </div>
              <div class="text-right">
                <p class="font-bold text-gray-800">Rp ${order.totalAmount.toLocaleString('id-ID')}</p>
                <span class="inline-block px-2 py-1 text-xs rounded-full ${status.class}">
                  ${status.text}
                </span>
              </div>
            `;
            recentOrdersContainer.appendChild(orderElement);
          });
        }
      } catch (error) {
        console.error('Error fetching recent orders:', error);
        document.getElementById('recentOrders').innerHTML = '<p class="text-red-500 text-center">Gagal memuat pesanan</p>';
      }
    }

    // Initialize
    fetchStats();
    fetchRecentOrders();
  </script>

</body>
</html>
