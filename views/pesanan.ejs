<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesanan Berhasil</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Midtrans Snap -->
    <script type="text/javascript" src="https://app.sandbox.midtrans.com/snap/snap.js" 
        data-client-key="<%= midtransClientKey %>"></script>
</head>
<body class="bg-gray-50">
    <%- include('partials/navbar') %>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <% if (order) { %>
            <!-- Order Created Successfully -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="text-center mb-6">
                    <div class="text-green-500 mb-4">
                        <i class="bi bi-check-circle-fill text-6xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Pesanan Berhasil Dibuat!</h1>
                    <p class="text-gray-600">Terima kasih telah berbelanja di Cemilanceria</p>
                    <div class="mt-4 inline-block bg-amber-50 px-4 py-2 rounded-lg">
                        <p class="text-sm text-gray-600">Nomor Pesanan:</p>
                        <p class="text-xl font-bold text-amber-600"><%= order.orderNumber %></p>
                    </div>
                </div>

                <!-- Order Status -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Status Pesanan:</p>
                            <p class="text-lg font-semibold 
                                <%= order.status === 'CONFIRMED' ? 'text-green-600' : 
                                    order.status === 'CANCELLED' ? 'text-red-600' : 
                                    'text-yellow-600' %>">
                                <%= order.status === 'PENDING' ? 'Menunggu Pembayaran' :
                                    order.status === 'CONFIRMED' ? 'Dikonfirmasi' :
                                    order.status === 'PROCESSING' ? 'Diproses' :
                                    order.status === 'SHIPPED' ? 'Dikirim' :
                                    order.status === 'DELIVERED' ? 'Diterima' :
                                    'Dibatalkan' %>
                            </p>
                        </div>
                        <% if (order.status === 'PENDING') { %>
                            <div class="text-yellow-500">
                                <i class="bi bi-clock-history text-4xl"></i>
                            </div>
                        <% } else if (order.status === 'CONFIRMED') { %>
                            <div class="text-green-500">
                                <i class="bi bi-check-circle text-4xl"></i>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Customer Info -->
                <div class="mb-6 p-4 border rounded-lg">
                    <h3 class="font-semibold text-lg mb-3 text-gray-800">
                        <i class="bi bi-person-circle text-amber-500"></i>
                        Informasi Pengiriman
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div>
                            <p class="text-gray-600">Email:</p>
                            <p class="font-medium"><%= order.user?.email || '-' %></p>
                        </div>
                        <div>
                            <p class="text-gray-600">Telepon:</p>
                            <p class="font-medium"><%= order.user?.phone || '-' %></p>
                        </div>
                        <div class="md:col-span-2">
                            <p class="text-gray-600">Alamat Pengiriman:</p>
                            <p class="font-medium"><%= order.shippingAddress %></p>
                        </div>
                        <% if (order.notes) { %>
                            <div class="md:col-span-2">
                                <p class="text-gray-600">Catatan:</p>
                                <p class="font-medium"><%= order.notes %></p>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="mb-6 p-4 border rounded-lg">
                    <h3 class="font-semibold text-lg mb-3 text-gray-800">
                        <i class="bi bi-cart-check text-amber-500"></i>
                        Detail Produk
                    </h3>
                    <div class="space-y-3">
                        <% order.orderItems.forEach(item => { %>
                            <div class="flex justify-between items-center py-2 border-b last:border-0">
                                <div class="flex gap-3 flex-1">
                                    <% if (item.product.imageUrl) { %>
                                        <img src="<%= item.product.imageUrl %>" alt="<%= item.product.name %>" 
                                            class="w-16 h-16 object-cover rounded-lg">
                                    <% } else { %>
                                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center">
                                            <i class="bi bi-image text-2xl text-gray-400"></i>
                                        </div>
                                    <% } %>
                                    <div>
                                        <p class="font-medium text-gray-800"><%= item.product.name %></p>
                                        <p class="text-sm text-gray-600">
                                            <%= item.quantity %>x Rp <%= item.price.toLocaleString('id-ID') %>
                                        </p>
                                    </div>
                                </div>
                                <p class="font-semibold text-gray-800">
                                    Rp <%= item.subtotal.toLocaleString('id-ID') %>
                                </p>
                            </div>
                        <% }) %>
                    </div>

                    <!-- Total -->
                    <div class="mt-4 pt-4 border-t">
                        <div class="flex justify-between items-center text-lg font-bold">
                            <span class="text-gray-800">Total:</span>
                            <span class="text-amber-600">Rp <%= order.totalAmount.toLocaleString('id-ID') %></span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <% if (order.status === 'PENDING') { %>
                        <button id="payButton" 
                            class="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-medium py-3 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                            <i class="bi bi-credit-card"></i>
                            Bayar Sekarang
                        </button>
                    <% } %>
                    <% if (typeof user !== 'undefined' && user) { %>
                        <a href="/dashboard" 
                            class="<%= order.status === 'PENDING' ? 'flex-1' : 'w-full' %> text-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                            <i class="bi bi-speedometer2"></i>
                            Dashboard
                        </a>
                    <% } else { %>
                        <a href="/" 
                            class="<%= order.status === 'PENDING' ? 'flex-1' : 'w-full' %> text-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                            <i class="bi bi-house"></i>
                            Kembali ke Beranda
                        </a>
                    <% } %>
                </div>
            </div>
        <% } else { %>
            <!-- No Order Found -->
            <div class="bg-white rounded-lg shadow-md p-6 text-center">
                <div class="text-gray-400 mb-4">
                    <i class="bi bi-receipt text-6xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Tidak Ada Pesanan</h1>
                <p class="text-gray-600 mb-6">Silakan buat pesanan terlebih dahulu</p>
                <a href="/products" class="inline-block bg-amber-500 hover:bg-amber-600 text-white font-medium py-3 px-6 rounded-lg transition duration-300">
                    <i class="bi bi-cart"></i>
                    Belanja Sekarang
                </a>
            </div>
        <% } %>
    </div>

    <%- include('partials/footer') %>

    <% if (order && order.status === 'PENDING') { %>
    <script>
        const payButton = document.getElementById('payButton');
        const snapToken = '<%= order.snapToken %>';

        payButton.addEventListener('click', function() {
            if (!snapToken) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Token pembayaran tidak tersedia',
                    confirmButtonColor: '#f59e0b'
                });
                return;
            }

            // Trigger Midtrans Snap
            snap.pay(snapToken, {
                onSuccess: function(result) {
                    console.log('Payment success:', result);
                    Swal.fire({
                        icon: 'success',
                        title: 'Pembayaran Berhasil!',
                        text: 'Terima kasih atas pembayaran Anda',
                        confirmButtonColor: '#f59e0b'
                    }).then(() => {
                        window.location.reload();
                    });
                },
                onPending: function(result) {
                    console.log('Payment pending:', result);
                    Swal.fire({
                        icon: 'info',
                        title: 'Pembayaran Pending',
                        text: 'Silakan selesaikan pembayaran Anda',
                        confirmButtonColor: '#f59e0b'
                    });
                },
                onError: function(result) {
                    console.log('Payment error:', result);
                    Swal.fire({
                        icon: 'error',
                        title: 'Pembayaran Gagal',
                        text: 'Terjadi kesalahan saat memproses pembayaran',
                        confirmButtonColor: '#f59e0b'
                    });
                },
                onClose: function() {
                    console.log('Payment popup closed');
                }
            });
        });
    </script>
    <% } %>
</body>
</html>
