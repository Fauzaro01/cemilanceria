<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Users | Cemilan Ceria</title>
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

  <!-- ðŸ”— Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: '#FF7F00',
              light: '#FFA756',
              dark: '#CC6600',
            }
          }
        }
      }
    }
  </script>

  <!-- ðŸŽ¨ Font & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      font-family: 'Source Sans Pro', system-ui, sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50">

  <div class="flex min-h-screen">
    <!-- Sidebar (include partial) -->
    <%- include('../partials/sidebars.ejs', {activeMenu: activeMenu}) %>

    <!-- Main Content -->
    <div class="flex flex-col flex-1">
      <!-- Top Header -->
      <header class="bg-white shadow-sm">
        <div class="px-6 py-4">
          <h1 class="text-2xl font-bold text-gray-800">Kelola Pengguna</h1>
        </div>
      </header>

      <!-- Content -->
      <main class="flex-1 p-6 overflow-auto">
        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
          <div class="flex flex-wrap gap-4 items-center">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
              <select id="filterRole" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                <option value="all">Semua</option>
                <option value="USER">User</option>
                <option value="ADMIN">Admin</option>
              </select>
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-1">Cari</label>
              <input type="text" id="searchUser" placeholder="Cari nama atau email..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
            </div>
            <div class="self-end">
              <button onclick="loadUsers()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition">
                <i class="fas fa-search mr-2"></i>Filter
              </button>
            </div>
          </div>
        </div>

        <!-- Users Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
          <div class="p-6 overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3">Nama</th>
                  <th scope="col" class="px-6 py-3">Email</th>
                  <th scope="col" class="px-6 py-3">Telepon</th>
                  <th scope="col" class="px-6 py-3">Role</th>
                  <th scope="col" class="px-6 py-3">Total Pesanan</th>
                  <th scope="col" class="px-6 py-3">Status</th>
                  <th scope="col" class="px-6 py-3">Bergabung</th>
                  <th scope="col" class="px-6 py-3">Aksi</th>
                </tr>
              </thead>
              <tbody id="usersTable">
                <tr>
                  <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Memuat data...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div id="pagination" class="px-6 py-4 border-t border-gray-100 flex items-center justify-between">
            <!-- Pagination will be inserted here -->
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="bg-white border-t border-gray-200 py-4 px-6 text-sm text-gray-600">
        <strong>&copy; 2025 <a href="#" class="text-primary font-medium hover:underline">Cemilan Ceria</a>.</strong>
        All rights reserved.
      </footer>
    </div>
  </div>

  <script>
    let currentPage = 1;
    const limit = 10;

    // Load users from API
    async function loadUsers(page = 1) {
      try {
        const role = document.getElementById('filterRole').value;
        const search = document.getElementById('searchUser').value;
        
        const params = new URLSearchParams({
          page,
          limit,
          role,
          search
        });

        const response = await fetch(`/api/admin/users?${params}`);
        const result = await response.json();
        
        if (result.success) {
          renderUsers(result.data);
          renderPagination(result.pagination);
          currentPage = page;
        }
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTable').innerHTML = `
          <tr>
            <td colspan="8" class="px-6 py-8 text-center text-red-500">
              <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
              <p>Gagal memuat data pengguna</p>
            </td>
          </tr>
        `;
      }
    }

    // Render users table
    function renderUsers(users) {
      const tbody = document.getElementById('usersTable');
      
      if (users.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-6 py-8 text-center text-gray-500">
              <i class="fas fa-inbox text-2xl mb-2"></i>
              <p>Tidak ada pengguna</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = users.map(user => {
        const date = new Date(user.createdAt).toLocaleDateString('id-ID', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
        
        const roleClass = user.role === 'ADMIN' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';
        const statusClass = user.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        
        return `
          <tr class="bg-white border-b hover:bg-gray-50">
            <td class="px-6 py-4">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-white font-medium mr-3">
                  ${user.name.charAt(0).toUpperCase()}
                </div>
                <p class="font-medium text-gray-900">${user.name}</p>
              </div>
            </td>
            <td class="px-6 py-4">${user.email}</td>
            <td class="px-6 py-4">${user.phone || '-'}</td>
            <td class="px-6 py-4">
              <span class="px-2 py-1 text-xs font-medium rounded-full ${roleClass}">
                ${user.role}
              </span>
            </td>
            <td class="px-6 py-4 text-center">
              <span class="font-semibold">${user._count.orders}</span>
            </td>
            <td class="px-6 py-4">
              <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                ${user.isActive ? 'Aktif' : 'Nonaktif'}
              </span>
            </td>
            <td class="px-6 py-4">${date}</td>
            <td class="px-6 py-4">
              <button onclick="toggleUserStatus(${user.id}, ${user.isActive})" class="px-3 py-1 text-sm ${user.isActive ? 'bg-red-100 text-red-600 hover:bg-red-200' : 'bg-green-100 text-green-600 hover:bg-green-200'} rounded transition">
                ${user.isActive ? 'Nonaktifkan' : 'Aktifkan'}
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Render pagination
    function renderPagination(pagination) {
      const container = document.getElementById('pagination');
      
      if (pagination.totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let paginationHTML = `
        <div class="text-sm text-gray-600">
          Halaman ${pagination.page} dari ${pagination.totalPages} (Total: ${pagination.total} pengguna)
        </div>
        <div class="flex gap-2">
      `;

      // Previous button
      if (pagination.page > 1) {
        paginationHTML += `
          <button onclick="loadUsers(${pagination.page - 1})" class="px-3 py-1 border rounded hover:bg-gray-100">
            <i class="fas fa-chevron-left"></i>
          </button>
        `;
      }

      // Page numbers
      for (let i = 1; i <= pagination.totalPages; i++) {
        if (i === pagination.page) {
          paginationHTML += `
            <button class="px-3 py-1 bg-orange-500 text-white rounded">${i}</button>
          `;
        } else if (i === 1 || i === pagination.totalPages || Math.abs(i - pagination.page) <= 1) {
          paginationHTML += `
            <button onclick="loadUsers(${i})" class="px-3 py-1 border rounded hover:bg-gray-100">${i}</button>
          `;
        } else if (i === pagination.page - 2 || i === pagination.page + 2) {
          paginationHTML += `<span class="px-2">...</span>`;
        }
      }

      // Next button
      if (pagination.page < pagination.totalPages) {
        paginationHTML += `
          <button onclick="loadUsers(${pagination.page + 1})" class="px-3 py-1 border rounded hover:bg-gray-100">
            <i class="fas fa-chevron-right"></i>
          </button>
        `;
      }

      paginationHTML += `</div>`;
      container.innerHTML = paginationHTML;
    }

    // Toggle user active status
    async function toggleUserStatus(userId, currentStatus) {
      const action = currentStatus ? 'menonaktifkan' : 'mengaktifkan';
      
      const confirm = await Swal.fire({
        title: 'Konfirmasi',
        text: `Apakah Anda yakin ingin ${action} pengguna ini?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#FF7F00',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ya, lanjutkan',
        cancelButtonText: 'Batal'
      });

      if (!confirm.isConfirmed) return;

      try {
        const response = await fetch(`/api/admin/users/${userId}/toggle-active`, {
          method: 'PUT'
        });

        const result = await response.json();

        if (result.success) {
          Swal.fire({
            icon: 'success',
            title: 'Berhasil!',
            text: result.message,
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000
          });
          loadUsers(currentPage);
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Error toggling user status:', error);
        Swal.fire({
          icon: 'error',
          title: 'Gagal!',
          text: error.message
        });
      }
    }

    // Event listeners
    document.getElementById('searchUser').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        loadUsers(1);
      }
    });

    // Initialize
    loadUsers();
  </script>

</body>
</html>
